<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GobLab Gran Canaria - Tu Mentor IA para Emprender</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .app-container{display:flex;height:100vh;max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(10px)}
    .chat-panel{flex:1;display:flex;flex-direction:column;background:#fff;border-radius:20px 0 0 20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:25px 30px;border-radius:20px 0 0 0;position:relative}
    .mentor-info h1{font-size:24px;font-weight:600;margin-bottom:5px}
    .mentor-info p{font-size:14px;opacity:.9}
    .connection-status{position:absolute;top:15px;right:20px;display:flex;align-items:center;gap:8px;font-size:12px;background:rgba(255,255,255,.2);padding:5px 10px;border-radius:15px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#ff6b6b}
    .status-dot.connected{background:#51cf66}
    .chat-messages{flex:1;overflow-y:auto;padding:30px;background:#fafafa}
    .message{margin-bottom:25px;animation:slideIn .5s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .message.ai{display:flex;gap:15px}
    .message.user{display:flex;gap:15px;flex-direction:row-reverse;margin-left:50px}
    .message-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .message.ai .message-avatar{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .message.user .message-avatar{background:linear-gradient(135deg,#4ade80 0%,#16a34a 100%);color:#fff}
    .message-content{flex:1;background:#fff;padding:20px;border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .message.user .message-content{background:linear-gradient(135deg,#e0f2fe 0%,#b3e5fc 100%)}
    .message-text{line-height:1.6;font-size:15px}
    .error-message{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%);color:#fff;padding:15px 20px;border-radius:12px;margin:20px 0;display:flex;align-items:center;gap:10px}
    .typing-indicator{display:flex;align-items:center;gap:15px;padding:20px 30px}
    .typing-dots{display:flex;gap:5px}
    .typing-dot{width:8px;height:8px;background:#667eea;border-radius:50%;animation:typingDot 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typingDot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
    .chat-input{padding:25px 30px;background:#fff;border-top:1px solid #e5e7eb;border-radius:0 0 0 20px}
    .input-container{display:flex;gap:15px;align-items:flex-end}
    .input-field{flex:1;border:2px solid #e5e7eb;border-radius:25px;padding:15px 20px;font-size:15px;resize:none;min-height:50px;max-height:120px;transition:all .3s}
    .input-field:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .send-button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;width:50px;height:50px;border-radius:50%;font-size:20px;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
    .send-button:hover{transform:scale(1.1);box-shadow:0 4px 15px rgba(102,126,234,.4)}
    .send-button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .progress-panel{width:400px;background:#fff;border-radius:0 20px 20px 0;box-shadow:0 10px 30px rgba(0,0,0,.1);display:flex;flex-direction:column}
    .progress-header{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff;padding:25px;border-radius:0 20px 0 0}
    .progress-title{font-size:18px;font-weight:600;margin-bottom:10px}
    .progress-subtitle{font-size:14px;opacity:.9}
    .plan-preview{flex:1;padding:25px;overflow-y:auto}
    .plan-section{margin-bottom:20px;padding:15px;background:#f8fafc;border-radius:8px;border-left:4px solid #e5e7eb;transition:all .3s}
    .plan-section.active{border-left-color:#f59e0b;background:#fffbeb}
    .plan-section.completed{border-left-color:#10b981;background:#ecfdf5}
    .section-title{font-size:14px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .section-status{width:18px;height:18px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff}
    .section-status.active{background:#f59e0b;animation:pulse 2s infinite}
    .section-status.completed{background:#10b981}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .section-content{font-size:12px;color:#6b7280;line-height:1.4}
    .welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:50px;height:100%}
    .welcome-icon{width:80px;height:80px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;margin-bottom:25px;animation:bounce 2s infinite}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    .welcome-title{font-size:28px;font-weight:700;margin-bottom:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .welcome-subtitle{font-size:16px;color:#6b7280;margin-bottom:30px;max-width:400px;line-height:1.6}
    .start-button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:15px 30px;border-radius:25px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s}
    .start-button:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(102,126,234,.4)}
    .quick-responses{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px}
    .quick-response{background:rgba(102,126,234,.1);color:#667eea;border:1px solid rgba(102,126,234,.2);padding:8px 15px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
    .quick-response:hover{background:#667eea;color:#fff;transform:translateY(-2px)}
    .message-actions{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap}
    .action-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(102,126,234,.4)}
    @media (max-width:1024px){
      .app-container{flex-direction:column}
      .progress-panel{width:100%;height:200px;border-radius:0}
      .chat-panel{border-radius:0}
    }
  </style>
</head>
<body>
<div class="app-container">
  <div class="chat-panel">
    <div class="chat-header">
      <div class="mentor-info">
        <h1>Alex - Tu Mentor IA para crear Planes de Negocio</h1>
        <p>GobLab Gran Canaria - Laboratorio de Innovaci√≥n P√∫blica</p>
      </div>
      <div class="connection-status" id="connectionStatus">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Conectando...</span>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-icon">üöÄ</div>
        <h1 class="welcome-title">¬°Hola! Soy Alex</h1>
        <p class="welcome-subtitle">
          Tu mentor de inteligencia artificial del GobLab Gran Canaria. Te ayudo a crear un plan de negocio profesional de forma conversacional y sencilla.
        </p>
        <button class="start-button" id="startBtn">Comenzar mi plan de negocio</button>
      </div>
    </div>

    <div class="chat-input">
      <div class="input-container">
        <textarea class="input-field" id="messageInput" placeholder="Escribe tu respuesta aqu√≠..." disabled></textarea>
        <button class="send-button" id="sendBtn" disabled>‚û§</button>
      </div>
    </div>
  </div>

  <div class="progress-panel">
    <div class="progress-header">
      <div class="progress-title">Tu Plan de Negocio</div>
      <div class="progress-subtitle">Cre√°ndose autom√°ticamente</div>
    </div>

    <div class="plan-preview" id="planPreview">
      <div class="plan-section" id="section-name">
        <div class="section-title"><div class="section-status">1</div>Tu Informaci√≥n</div>
        <div class="section-content">Esperando tu nombre...</div>
      </div>
      <div class="plan-section" id="section-idea">
        <div class="section-title"><div class="section-status">2</div>Tu Idea de Negocio</div>
        <div class="section-content">Pendiente de completar...</div>
      </div>
      <div class="plan-section" id="section-problem">
        <div class="section-title"><div class="section-status">3</div>Problema que Resuelves</div>
        <div class="section-content">Pendiente de completar...</div>
      </div>
      <div class="plan-section" id="section-customer">
        <div class="section-title"><div class="section-status">4</div>Cliente Objetivo</div>
        <div class="section-content">Pendiente de completar...</div>
      </div>
      <div class="plan-section" id="section-revenue">
        <div class="section-title"><div class="section-status">5</div>Modelo de Ingresos</div>
        <div class="section-content">Pendiente de completar...</div>
      </div>
      <div class="plan-section" id="section-research">
        <div class="section-title"><div class="section-status">6</div>Investigaci√≥n de Mercado</div>
        <div class="section-content">An√°lisis IA pendiente...</div>
      </div>
      <div class="plan-section" id="section-final">
        <div class="section-title"><div class="section-status">7</div>Plan Completo</div>
        <div class="section-content">Generaci√≥n final pendiente...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const CONFIG = {
  webhookUrl: 'https://n8n.icc-e.org/webhook/mentor-chat',
  requestTimeout: 55000, // 55 segundos para evitar timeout del webhook
  maxRetries: 0, // Sin reintentos
  retryDelay: 0 // No usado
};

/* ===================== STATE & DOM ===================== */
const state = {
  userId: null,
  sessionId: null,
  currentStep: 0,
  isConnected: false,
  isTyping: false,
  conversationData: {}
};

let lastUserMessage = '';

const elements = {
  startBtn: document.getElementById('startBtn'),
  sendBtn: document.getElementById('sendBtn'),
  messageInput: document.getElementById('messageInput'),
  chatMessages: document.getElementById('chatMessages'),
  welcomeScreen: document.getElementById('welcomeScreen'),
  statusDot: document.getElementById('statusDot'),
  statusText: document.getElementById('statusText')
};

const stepSectionMap = {
  1: 'section-name',
  2: 'section-idea',
  3: 'section-problem',
  4: 'section-customer',
  5: 'section-revenue',
  6: 'section-research',
  7: 'section-final'
};

/* ===================== INIT ===================== */
document.addEventListener('DOMContentLoaded', initializeApp);

function initializeApp() {
  state.userId = `user_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
  state.sessionId = `session_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;

  elements.startBtn.addEventListener('click', startConversation);
  elements.sendBtn.addEventListener('click', sendMessage);
  elements.messageInput.addEventListener('keypress', handleKeyPress);

  checkConnection();

  console.log('Alex MVP inicializado', {
    userId: state.userId,
    sessionId: state.sessionId,
    webhookUrl: CONFIG.webhookUrl
  });
}

function sendMessage() {
  const message = elements.messageInput.value.trim();
  if (!message || state.isTyping) return;

  lastUserMessage = message;
  showUserMessage(message);
  elements.messageInput.value = '';
  removeQuickReplies();
  
  processMessage(message);
}

async function sendMessageNoWait(message) {
  const payload = {
    message,
    userId: state.userId,
    sessionId: state.sessionId,
    currentStep: state.currentStep,
    state: state.conversationData
  };

  try {
    // Fire and forget - no esperamos respuesta
    fetch(CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit'
    }).catch(() => {
      // Ignoramos errores en fire and forget
      console.log('Fire and forget request - no esperamos respuesta');
    });
  } catch (error) {
    console.log('Error en fire and forget (ignorado):', error);
  }
}

/* ===================== CONNECTION ===================== */
async function checkConnection() {
  console.log('Verificando conexi√≥n...');
  const payload = { 
    message: '_connection_test', 
    userId: state.userId, 
    sessionId: state.sessionId 
  };

  try {
    const response = await fetch(CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit',
      signal: AbortSignal.timeout(CONFIG.requestTimeout)
    });

    let data = {};
    try {
      const contentType = response.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        data = await response.json();
      } else {
        data = { raw: await response.text() };
      }
    } catch(e) {
      console.warn('Respuesta no es JSON v√°lido:', e);
    }

    if (response.ok) {
      console.log('Conectado exitosamente');
      setConnectionStatus(true, 'Conectado');
    } else {
      console.warn('Conexi√≥n fallida:', response.status);
      setConnectionStatus(false, `Error ${response.status}`);
    }
    return data;
  } catch (error) {
    console.error('Error en conexi√≥n:', error);
    setConnectionStatus(false, 'Error de conexi√≥n');
    return {};
  }
}

function setConnectionStatus(connected, message) {
  state.isConnected = connected;
  elements.statusDot.classList.toggle('connected', connected);
  elements.statusText.textContent = message;
}

/* ===================== INPUT HANDLING ===================== */
function handleKeyPress(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function startConversation() {
  if (!state.isConnected) {
    showError('No hay conexi√≥n con el servidor. Reintentando...');
    checkConnection();
    return;
  }
  
  console.log('Iniciando conversaci√≥n...');
  
  elements.welcomeScreen.style.display = 'none';
  elements.messageInput.disabled = false;
  elements.sendBtn.disabled = false;
  elements.messageInput.focus();

  setTimeout(async () => {
    console.log('Enviando mensaje de inicio...');
    try {
      const previousMessage = lastUserMessage;
      lastUserMessage = '_iniciar_conversacion';
      await processMessage('_iniciar_conversacion');
      
      if (previousMessage && previousMessage !== '_iniciar_conversacion') {
        lastUserMessage = previousMessage;
      }
    } catch (error) {
      console.error('Error iniciando conversaci√≥n:', error);
      showError('Error iniciando conversaci√≥n. Intenta de nuevo.');
    }
  }, 400);
}

/* ===================== BACKEND COMMUNICATION ===================== */
async function processMessage(message, retryCount = 0) {
  showTyping();

  const isGeneratingPlan = message.toLowerCase().includes('generar plan completo');
  
  if (isGeneratingPlan) {
    // NO mostrar mensaje aqu√≠ - ya se mostr√≥ en selectQuickReply
    setTimeout(() => {
      hideTyping();
      // Marcar progreso sin mensaje adicional
      
      // Iniciar polling despu√©s de 55 segundos
      setTimeout(() => {
        console.log('Iniciando polling para generaci√≥n de plan...');
        startPollingForPDF();
      }, 55000);
    }, 500);
    
    // Enviar mensaje pero SIN mostrar error en consola
    sendMessageSilent(message);
    return;
  }

  // Correcci√≥n 3: Nueva funci√≥n sendMessageSilent para evitar error 504 en consola
async function sendMessageSilent(message) {
  const payload = {
    message,
    userId: state.userId,
    sessionId: state.sessionId,
    currentStep: state.currentStep,
    state: state.conversationData
  };

  try {
    // Crear AbortController para cancelar despu√©s de 50s
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 50000);

    fetch(CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit',
      signal: controller.signal
    }).then(() => {
      clearTimeout(timeoutId);
      console.log('Fire and forget completado exitosamente');
    }).catch((error) => {
      clearTimeout(timeoutId);
      // No mostrar error - es esperado para fire and forget
      console.log('Fire and forget terminado (esperado):', error.name);
    });

  } catch (error) {
    // Silenciar completamente - no mostrar en consola
  }
}

  // Para mensajes normales - contin√∫a igual...
  const payload = {
    message,
    userId: state.userId,
    sessionId: state.sessionId,
    currentStep: state.currentStep,
    state: state.conversationData
  };
  
  console.log(`Enviando mensaje (sin reintentos):`, payload);

  try {
    const response = await fetch(CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit',
      signal: AbortSignal.timeout(55000)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const contentType = response.headers.get('content-type') || '';
    const data = contentType.includes('application/json') 
      ? await response.json()
      : { success: true, response: await response.text() };

    console.log('Respuesta recibida:', data);
    hideTyping();
    handleSuccessfulResponse(data);

  } catch (error) {
    hideTyping();
    console.error(`Error en comunicaci√≥n:`, error);
    
    if (error.name === 'AbortError' || error.message.includes('timeout')) {
      showAIMessage("El servidor est√° procesando tu solicitud. Te mantendr√© informado del progreso...");
      setTimeout(() => startPollingForPDF(), 10000);
    } else {
      showError('Error conectando con Alex. Por favor, intenta de nuevo.');
      setConnectionStatus(false, 'Error de conexi√≥n');
    }
  }
}

function handleSuccessfulResponse(data) {
  console.log('Procesando respuesta:', data);
  
  if (!data || data.success === false) {
    console.warn('Respuesta inv√°lida del servidor:', data);
    showError('La respuesta del servidor no es v√°lida.');
    return;
  }

  // Manejar PDF generado
  if (data.pdfGenerated && data.pdfUrl) {
    console.log('PDF generado:', data.pdfUrl);
    
    // Guardar URL del PDF
    localStorage.setItem('alex_last_pdf_url', data.pdfUrl);
    localStorage.setItem('alex_last_pdf_filename', data.fileName || `plan_negocio_${Date.now()}.pdf`);
    
    // Actualizar estado
    if (data.state) {
      state.conversationData = data.state;
    }
    
    // Marcar todas las secciones como completadas
    for (let i = 1; i <= 7; i++) {
      markSectionCompleted(i);
    }
    
    // Mostrar mensaje de finalizaci√≥n
    showAIMessage(
      '¬°Tu Plan de Negocio est√° listo! He creado un documento profesional de 25 p√°ginas con an√°lisis espec√≠fico para Gran Canaria.',
      [
        { text: 'üìÑ Descargar PDF', handler: `downloadPlan()` },
        { text: 'üìß Enviar por email', handler: 'promptEmailAndSend()' },
        { text: 'üí¨ Hacer consultas', handler: 'askQuestions()' },
        { text: 'üîÑ Crear nuevo plan', handler: 'clearSession()' }
      ]
    );
    
    elements.messageInput.placeholder = 'Plan completado. Selecciona una opci√≥n arriba o haz consultas espec√≠ficas.';
    return;
  }

  // Procesar respuesta normal
  const aiText = data.response || data.message;
  if (aiText && aiText !== "Error: no hay respuesta") {
    // Workaround: si recibimos "Respuesta procesada" despu√©s de "Generar plan completo"
    if (aiText === "Respuesta procesada" && lastUserMessage === "Generar plan completo") {
      showAIMessage("¬°Perfecto! Estoy generando tu plan de negocio completo con an√°lisis de mercado espec√≠fico para Gran Canaria. Esto tomar√° unos momentos...");
      // Forzar finalizaci√≥n
      markSectionCompleted(6);
      markSectionCompleted(7);
      setTimeout(() => {
        showAIMessage(
          '¬°Tu Plan de Negocio est√° listo! He creado un documento profesional de 25 p√°ginas con an√°lisis espec√≠fico para Gran Canaria.',
          [
            { text: 'üìÑ Descargar PDF', handler: `downloadPlan()` },
            { text: 'üìß Enviar por email', handler: 'promptEmailAndSend()' },
            { text: 'üí¨ Hacer consultas', handler: 'askQuestions()' },
            { text: 'üîÑ Crear nuevo plan', handler: 'clearSession()' }
          ]
        );
      }, 3000);
    } else {
      showAIMessage(aiText);
    }
  }

  // Actualizar estado
  const previousStep = state.currentStep;
  if (data.currentStep !== undefined) {
    state.currentStep = parseInt(data.currentStep);
    console.log(`Paso cambi√≥ de: ${previousStep} ‚Üí ${state.currentStep}`);
  }
  
  if (data.state) {
    state.conversationData = data.state;
  }

  // Procesar secciones basado en transici√≥n de pasos
  if (lastUserMessage !== '_iniciar_conversacion' && data.currentStep > previousStep) {
    updatePlanSection(lastUserMessage, data.currentStep);
  }

  // Manejo de respuestas r√°pidas
  if (Array.isArray(data.quickReplies) && data.quickReplies.length > 0) {
    addQuickReplies(data.quickReplies);
  }
  
  // Verificaci√≥n de completitud
  if (data.isComplete && !data.pdfGenerated) {
    showAIMessage('Generando tu Plan de Negocio en PDF... Un momento por favor...');
  }
}

/* ===================== PLAN MANAGEMENT ===================== */
function updatePlanSection(userMessage, receivedStep) {
  console.log('Actualizando secci√≥n:', { userMessage, receivedStep });

  const completedStep = receivedStep - 1;
  const sectionId = stepSectionMap[completedStep];
  
  if (!sectionId) {
    console.warn('No se encontr√≥ secci√≥n para el paso:', completedStep);
    return;
  }

  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Elemento de secci√≥n no encontrado:', sectionId);
    return;
  }

  // Marcar como completada
  markSectionCompleted(completedStep, userMessage);

  // Marcar secciones anteriores como completadas
  for (let i = 1; i <= completedStep; i++) {
    markSectionCompleted(i);
  }

  // Activar siguiente secci√≥n
  if (receivedStep <= 7) {
    const nextSectionId = stepSectionMap[receivedStep];
    if (nextSectionId) {
      activateSection(nextSectionId);
    }
  }
}

function markSectionCompleted(stepNumber, content = null) {
  const sectionId = stepSectionMap[stepNumber];
  const section = document.getElementById(sectionId);
  
  if (!section) return;

  const status = section.querySelector('.section-status');
  const contentElement = section.querySelector('.section-content');

  section.classList.remove('active');
  section.classList.add('completed');
  status.classList.add('completed');
  status.textContent = '‚úì';
  
  // Actualizar contenido espec√≠fico
  if (content && content.trim() && content !== '_iniciar_conversacion') {
    const shortText = content.length > 50 ? content.substring(0, 50) + '...' : content;
    contentElement.textContent = shortText;
  }

  // Contenido especial para secciones espec√≠ficas
  if (stepNumber === 6) {
    contentElement.innerHTML = `
      <strong>An√°lisis completado:</strong><br>
      ‚Ä¢ Mercado analizado<br>
      ‚Ä¢ Competidores identificados<br>
      ‚Ä¢ Oportunidades detectadas
    `;
  } else if (stepNumber === 7) {
    contentElement.innerHTML = `
      <strong>Plan generado:</strong><br>
      ‚Ä¢ 25 p√°ginas profesionales<br>
      ‚Ä¢ An√°lisis financiero<br>
      ‚Ä¢ Roadmap implementaci√≥n
    `;
  }
}

function activateSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section && !section.classList.contains('completed')) {
    section.classList.add('active');
    const status = section.querySelector('.section-status');
    status.classList.add('active');
  }
}

/* ===================== EMAIL FUNCTIONALITY ===================== */
function promptEmailAndSend() {
  const email = prompt('¬øA qu√© direcci√≥n de email quieres enviar tu plan de negocio?\n\nEjemplo: tunombre@gmail.com');
  
  if (!email) return;
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showError('Por favor introduce un email v√°lido (ejemplo: nombre@dominio.com)');
    return;
  }
  
  sendPlanByEmail(email);
}

async function sendPlanByEmail(email) {
  const pdfUrl = localStorage.getItem('alex_last_pdf_url');
  
  if (!pdfUrl) {
    showError('No se encontr√≥ un PDF generado. Por favor, completa el proceso primero.');
    return;
  }
  
  showAIMessage(`üìß Enviando tu plan de negocio a ${email}... Un momento por favor.`);
  
  try {
    const response = await fetch(CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        message: '_send_email',
        to: email,
        pdfUrl: pdfUrl,
        userId: state.userId,
        sessionId: state.sessionId,
        state: state.conversationData
      }),
      mode: 'cors'
    });

    if (response.ok) {
      const data = await response.json();
      if (data.success !== false) {
        showAIMessage(`‚úÖ ¬°Plan enviado exitosamente a ${email}! 
        
        Revisa tu bandeja de entrada en los pr√≥ximos minutos.
        Si no lo ves, verifica la carpeta de spam.
        
        El email incluye:
        ‚Ä¢ Tu plan de negocio completo en PDF
        ‚Ä¢ Enlaces a recursos de financiaci√≥n
        ‚Ä¢ Informaci√≥n de contacto del GobLab`);
      } else {
        throw new Error(data.error || 'Error en el servidor');
      }
    } else {
      throw new Error('Error en el servidor');
    }
  } catch (error) {
    console.error('Error enviando email:', error);
    showError('No se pudo enviar el email en este momento. Puedes descargar el PDF directamente.');
  }
}

/* ===================== UTILITY FUNCTIONS ===================== */
function downloadPlan() {
  const pdfUrl = localStorage.getItem('alex_last_pdf_url');
  
  if (pdfUrl) {
    window.open(pdfUrl, '_blank');
    showAIMessage('‚úÖ Abriendo tu PDF en una nueva pesta√±a. Si no se abre autom√°ticamente, verifica que tu navegador no est√© bloqueando ventanas emergentes.');
  } else {
    showError('No se encontr√≥ un PDF generado. Por favor, completa todos los pasos primero.');
  }
}

function clearSession() {
  if (confirm('¬øEst√°s seguro de que quieres empezar un nuevo plan? Se perder√° el progreso actual.')) {
    localStorage.removeItem('alex_session_id');
    localStorage.removeItem('alex_last_pdf_url');
    localStorage.removeItem('alex_last_pdf_filename');
    state.sessionId = `session_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
    state.currentStep = 0;
    state.conversationData = {};
    window.location.reload();
  }
}

function askQuestions() {
  showAIMessage(`¬°Perfecto! Ahora puedo responder preguntas espec√≠ficas sobre tu plan de negocio.
  
  Puedes preguntarme sobre:
  ‚Ä¢ Detalles de financiaci√≥n disponible
  ‚Ä¢ Estrategias de marketing para ${state.conversationData.data?.cliente || 'tu cliente objetivo'}
  ‚Ä¢ An√°lisis de competencia en tu sector
  ‚Ä¢ Proyecciones financieras m√°s detalladas
  ‚Ä¢ Pasos legales para constituir tu empresa
  ‚Ä¢ Contactos y recursos en Gran Canaria
  
  ¬øQu√© te gustar√≠a saber?`);
  
  elements.messageInput.placeholder = 'Haz tu pregunta sobre el plan de negocio...';
  elements.messageInput.focus();
}

/* ===================== UI HELPERS ===================== */
function showUserMessage(message) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message user';
  messageDiv.innerHTML = `
    <div class="message-avatar">üë§</div>
    <div class="message-content"><div class="message-text">${escapeHTML(message)}</div></div>`;
  elements.chatMessages.appendChild(messageDiv);
  scrollToBottom();
}

function showAIMessage(message, actions = []) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message ai';
  let actionsHTML = '';
  if (actions.length > 0) {
    actionsHTML = '<div class="message-actions">' +
      actions.map(a => `<button class="action-btn" onclick="${escapeHTML(a.handler)}">${escapeHTML(a.text)}</button>`).join('') +
      '</div>';
  }
  messageDiv.innerHTML = `
    <div class="message-avatar">ü§ñ</div>
    <div class="message-content">
      <div class="message-text">${formatMessage(message)}</div>
      ${actionsHTML}
    </div>`;
  elements.chatMessages.appendChild(messageDiv);
  scrollToBottom();
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-message';
  errorDiv.innerHTML = `<span>‚ö†Ô∏è</span><span>${escapeHTML(message)}</span>`;
  elements.chatMessages.appendChild(errorDiv);
  scrollToBottom();
}

function showTyping() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator';
  typingDiv.id = 'typing';
  typingDiv.innerHTML = `
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <span>Alex est√° escribiendo...</span>`;
  elements.chatMessages.appendChild(typingDiv);
  state.isTyping = true;
  scrollToBottom();
}

function hideTyping() {
  const typing = document.getElementById('typing');
  if (typing) typing.remove();
  state.isTyping = false;
}

function addQuickReplies(replies) {
  setTimeout(() => {
    const quickDiv = document.createElement('div');
    quickDiv.className = 'quick-responses';
    quickDiv.id = 'quickReplies';
    quickDiv.innerHTML = replies.map(r => 
      `<div class="quick-response" onclick="selectQuickReply('${escapeHTML(r)}')">${escapeHTML(r)}</div>`
    ).join('');
    elements.chatMessages.appendChild(quickDiv);
    scrollToBottom();
  }, 400);
}

function selectQuickReply(reply) {
  if (reply === "Generar plan completo") {
    lastUserMessage = "Generar plan completo";
    showUserMessage("Generar plan completo");
    removeQuickReplies();
    
    // SOLO mostrar mensaje UNA VEZ aqu√≠
    showAIMessage("¬°Perfecto! Estoy generando tu plan de negocio completo con an√°lisis de mercado espec√≠fico para Gran Canaria. Esto tomar√° unos momentos...");
    markSectionCompleted(6);
    activateSection('section-final');
    
    // Procesar mensaje SIN mostrar mensaje adicional
    processMessage("Generar plan completo");
  } else {
    elements.messageInput.value = reply;
    sendMessage();
  }
}


async function startPollingForPDF() {
  console.log('Iniciando polling para PDF...');
  let attempts = 0;
  const maxAttempts = 15; // 15 intentos √ó 20s = 5 minutos m√°ximo
  
  const pollInterval = setInterval(async () => {
    attempts++;
    console.log(`Polling intento ${attempts}/${maxAttempts}`);
    
    try {
      const response = await fetch('https://n8n.icc-e.org/webhook/mentor-chat-pdf', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sessionId: state.sessionId,
          userId: state.userId
        }),
        mode: 'cors',
        signal: AbortSignal.timeout(15000) // 15 segundos timeout por intento
      });

      if (response.ok) {
        const data = await response.json();
        console.log('Polling response:', data);
        
        if (data.pdfGenerated && data.pdfUrl) {
          clearInterval(pollInterval);
          
          // PDF listo - actualizar UI
          localStorage.setItem('alex_last_pdf_url', data.pdfUrl);
          localStorage.setItem('alex_last_pdf_filename', data.fileName || `plan_negocio_${Date.now()}.pdf`);
          
          markSectionCompleted(7);
          
          showAIMessage(
            '¬°Tu Plan de Negocio est√° listo! üéâ He creado un documento profesional de 25 p√°ginas con an√°lisis espec√≠fico para Gran Canaria.',
            [
              { text: 'üìÑ Descargar PDF', handler: `downloadPlan()` },
              { text: 'üìß Enviar por email', handler: 'promptEmailAndSend()' },
              { text: 'üí¨ Hacer consultas', handler: 'askQuestions()' },
              { text: 'üîÑ Crear nuevo plan', handler: 'clearSession()' }
            ]
          );
          
          elements.messageInput.placeholder = 'Plan completado. Selecciona una opci√≥n arriba o haz consultas espec√≠ficas.';
          return;
        }
      }
      
      // Mensaje de progreso cada 5 intentos (cada 100 segundos)
      if (attempts % 5 === 0 && attempts < maxAttempts) {
        showAIMessage(`Generando tu plan... ${Math.round((attempts/maxAttempts)*100)}% completado. Un poco m√°s de paciencia.`);
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(pollInterval);
        showError('El PDF est√° tardando m√°s de lo esperado. Por favor, contacta con soporte o intenta de nuevo m√°s tarde.');
      }
    } catch (error) {
      console.error('Error en polling:', error);
      if (attempts >= maxAttempts) {
        clearInterval(pollInterval);
        showError('Error verificando el estado del PDF. Intenta de nuevo m√°s tarde.');
      }
    }
  }, 20000); // Polling cada 20 segundos
}

function removeQuickReplies() {
  const quick = document.getElementById('quickReplies');
  if (quick) quick.remove();
}

function scrollToBottom() {
  elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
}

/* ===================== UTILITY FUNCTIONS ===================== */
function escapeHTML(text) { 
  const div = document.createElement('div'); 
  div.textContent = text; 
  return div.innerHTML; 
}

function formatMessage(text) {
  return String(text || '')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
}

/* ===================== GLOBAL FUNCTION EXPOSURE ===================== */
window.downloadPlan = downloadPlan;
window.promptEmailAndSend = promptEmailAndSend;
window.askQuestions = askQuestions;
window.clearSession = clearSession;
window.selectQuickReply = selectQuickReply;
</script>
</body>
</html>